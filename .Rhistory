) +
guides(fill = guide_colorbar(title = "Adéquation\nenvironnementale")) +
labs(x = "Longitude", y = "Latitude") +
xlim(bbox[c(1,3)]) +
ylim(bbox[c(2,4)]) +
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(plot.margin = unit(rep(0.01, 4), "pt"))
p
p <- ggplot() +
geom_tile(data = tb, aes(x = x, y = y, fill = value)) +
geom_sf(data = isl) +
scale_fill_viridis_c(option = "E") +
guides(fill = guide_colorbar(title = "Adéquation\nenvironnementale")) +
labs(x = "Longitude", y = "Latitude") +
xlim(bbox[c(1,3)]) +
ylim(bbox[c(2,4)]) +
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(plot.margin = unit(rep(0.01, 4), "pt"))
p
p <- ggplot() +
geom_tile(data = tb, aes(x = x, y = y, fill = value)) +
geom_sf(data = isl) +
scale_fill_viridis_c(option = "C") +
guides(fill = guide_colorbar(title = "Adéquation\nenvironnementale")) +
labs(x = "Longitude", y = "Latitude") +
xlim(bbox[c(1,3)]) +
ylim(bbox[c(2,4)]) +
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(plot.margin = unit(rep(0.01, 4), "pt"))
p
p <- ggplot() +
geom_tile(data = tb, aes(x = x, y = y, fill = value)) +
geom_sf(data = isl) +
scale_fill_viridis_c(option = "D") +
guides(fill = guide_colorbar(title = "Adéquation\nenvironnementale")) +
labs(x = "Longitude", y = "Latitude") +
xlim(bbox[c(1,3)]) +
ylim(bbox[c(2,4)]) +
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(plot.margin = unit(rep(0.01, 4), "pt"))
x11(); p
x11(); plot(cgc$stdv.so)
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/boot.R")
vignette(package = "biomod2"
)
?get_variables_importance
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/boot.R")
cgc
x11(); plot(cgc$mean.sbt)
cgc_sub_sf
cgc_sub_sf$Majoidea$`Mithraculus forceps`
cgc_sub_sf$Majoidea$`Mithraculus forceps` %>% dim()
superFamilies
supfm <- "Majoidea"
species$species[species$superFamily == supfm]
spe <- "Stenorhynchus seticornis"
spe
supfm
list.files(
here("data", "raw", "climatologies_globales_points", supfm, spe),
full.names = T
) %>%
lapply(read_csv, show_col_types = FALSE)
cg <- list.files(
here("data", "raw", "climatologies_globales_points", supfm, spe),
full.names = T
) %>%
lapply(read_csv, show_col_types = FALSE)
dim(cg[[1]])
global_occf$`Stenorhynchus seticornis` %>% dim()
cgc
names(cgc)
class(global_occf$`Amphithrax hemphilli`)
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
O <- global_occf[[supfm]][[spe]]
dim(O)
names(global_occf)
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
O <- global_occf[[spe]]
O
dim(O)
cg <- terra::extract(cgc, O)
cg
dim(cg)
View(cg)
table(is.na(cg$mean.sbt))
?terra:extract
?terra::extract
cg <- terra::extract(cgc, O, method = "bilinear")
table(is.na(cg$mean.sbt))
summary(cg$mean.sbt)
cg <- terra::extract(cgc, O, method = "simple")
summary(cg$mean.sbt)
table(is.na(cg$mean.sbt))
cg <- terra::extract(cgc, O, method = "bilinear")
table(is.na(cg$mean.sbt))
names(cg)
list.files(
here("data", "raw", "climatologies_globales_points", supfm, spe)
)
clim_global <- sapply(
superFamilies,
\(supfm) {
sapply(
species$species[species$superFamily == supfm],
\(spe) {
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
O <- global_occf[[spe]]
cg <- terra::extract(cgc, O, method = "bilinear")
table(is.na(cg$mean.sbt))
return(cg)
},
simplify  = F,
USE.NAMES = T
)
},
simplify  = F,
USE.NAMES = T
)
# Espèces à modéliser
species <- tibble(
superFamily = c(rep("Majoidea", 2), rep("Muricoidea", 2)),
species     = c(
"Amphithrax hemphilli",
"Macrocoeloma nodipes",
"Mithraculus coryphe",
"Mithraculus forceps",
"Mithrax pleuracanthus",
"Omalacantha bicornuta",
"Stenorhynchus seticornis",
"Teleophrys ruber",
"Claremontiella nodulosa",
"Coralliophila galea",
"Coralliophila salebrosa",
"Favartia alveata",
"Favartia varimutabilis",
"Phyllonotus pomum",
"Siratus consuelae",
"Stramonita rustica",
"Trachypollia didyma",
"Vasula deltoidea",
NULL
)
)
# Espèces à modéliser
species <- tibble(
superFamily = c(rep("Majoidea", 8), rep("Muricoidea", 10)),
species     = c(
"Amphithrax hemphilli",
"Macrocoeloma nodipes",
"Mithraculus coryphe",
"Mithraculus forceps",
"Mithrax pleuracanthus",
"Omalacantha bicornuta",
"Stenorhynchus seticornis",
"Teleophrys ruber",
"Claremontiella nodulosa",
"Coralliophila galea",
"Coralliophila salebrosa",
"Favartia alveata",
"Favartia varimutabilis",
"Phyllonotus pomum",
"Siratus consuelae",
"Stramonita rustica",
"Trachypollia didyma",
"Vasula deltoidea",
NULL
)
)
clim_global <- sapply(
superFamilies,
\(supfm) {
sapply(
species$species[species$superFamily == supfm],
\(spe) {
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
O <- global_occf[[spe]]
cg <- terra::extract(cgc, O, method = "bilinear")
table(is.na(cg$mean.sbt))
return(cg)
},
simplify  = F,
USE.NAMES = T
)
},
simplify  = F,
USE.NAMES = T
)
clim_global
clim_global <- sapply(
superFamilies,
\(supfm) {
sapply(
species$species[species$superFamily == supfm],
\(spe) {
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
O <- global_occf[[spe]]
cg <- terra::extract(cgc, O, method = "bilinear", ID = F)
table(is.na(cg$mean.sbt))
return(cg)
},
simplify  = F,
USE.NAMES = T
)
},
simplify  = F,
USE.NAMES = T
)
lapply(clim_global, \(x) table(is.na(x[, 1])))
clim_global
length(clim_global)
lapply(clim_global$Majoidea, \(x) table(is.na(x[, 1])))
lapply(clim_global$Muricoidea, \(x) table(is.na(x[, 1])))
# lapply(clim_global$Majoidea, \(x) table(is.na(x[, 1])))
# lapply(clim_global$Muricoidea, \(x) table(is.na(x[, 1])))
# Modification de la forme des climatologies global pour avoir une matrice
clim_global_tb <- sapply(
names(clim_global),
\(supfm) {
sapply(
names(clim_global[[supfm]]),
\(spe) {
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
cg <- clim_global[[supfm]][[spe]]
# coords <- cg$sbt[, c("x", "y")]
# uniformisation des stations présentes (problème avec so chais pas pk)
z <- names(which.min(lapply(cg, nrow) %>% unlist()))
tbm <- cg[[z]]
stn <- paste(tbm$x, tbm$y)
coords <- tbm[, c("x", "y")]
cg2 <- lapply(
names(cg),
\(n) {
tb <- cg[[n]]
# uniformisation des stations présentes (problème avec so chais pas pk)
tb <- if (nrow(tb) > length(stn)) {
tbi <- tb[paste(tb$x, tb$y) %in% stn, ]
tbi <- tbi[which(paste(tbi$x, tbi$y) %in% stn), ]
tbi
} else {
tb[which(paste(tb$x, tb$y) %in% stn), ]
}
tb <- tb %>%
select(-c(x, y))
names(tb) <- names(tb) %>%
str_split("_") %>%
lapply(pluck, 2) %>%
paste(n, sep = ".")
return(tb)
})
cbind(coords, do.call(cbind, cg2)) %>%
na.omit()
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
supfm <- "Majoidea"
spe <- "Stenorhynchus seticornis"
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
cg <- clim_global[[supfm]][[spe]]
# uniformisation des stations présentes (problème avec so chais pas pk)
z <- names(which.min(lapply(cg, nrow) %>% unlist()))
z
# sélection des variables environnementales uniquement
# et les métriques que l'on veut sélectionner (ici sd et mean)
cgc_sub <- sapply(
names(clim_global),
\(supfm) {
sapply(
names(clim_global[[supfm]]),
\(spe) {
tb <- clim_global[[supfm]][[spe]]
tb <- tb %>%
select(names(.)[grepl("stdv|mean", names(.))])
return(tb)
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
cgc_sub
clim_global <- sapply(
superFamilies,
\(supfm) {
sapply(
species$species[species$superFamily == supfm],
\(spe) {
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
O <- global_occf[[spe]]
cg <- terra::extract(cgc, O, method = "bilinear", ID = F)
return(na.omit(cg))
},
simplify  = F,
USE.NAMES = T
)
},
simplify  = F,
USE.NAMES = T
)
lapply(clim_global$Majoidea, \(x) table(is.na(x[, 1])))
lapply(clim_global$Muricoidea, \(x) table(is.na(x[, 1])))
# sélection des variables environnementales uniquement
# et les métriques que l'on veut sélectionner (ici sd et mean)
cgc_sub <- sapply(
names(clim_global),
\(supfm) {
sapply(
names(clim_global[[supfm]]),
\(spe) {
tb <- clim_global[[supfm]][[spe]]
tb <- tb %>%
select(names(.)[grepl("stdv|mean", names(.))])
return(tb)
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
# Filtre des variables colinéaires
cgc_sub <- sapply(
names(cgc_sub),
\(supfm) {
sapply(
names(cgc_sub[[supfm]]),
\(spe) {
tb <- cgc_sub[[supfm]][[spe]]
var_col <- usdm::vifstep(as.data.frame(tb %>% na.omit()))@excluded
tb <- tb[, !names(tb) %in% var_col]
return(tb)
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
# Même object en sf
cgc_sub_sf <- sapply(
names(cgc_sub),
\(supfm) {
sapply(
names(cgc_sub[[supfm]]),
\(spe) {
nms <- names(cgc_sub[[supfm]][[spe]])
tb <- clim_global_tb[[supfm]][[spe]]
st_as_sf(
tb %>% select(all_of(c("x", "y", nms))),
coords = c("x", "y"),
crs = "EPSG:4326"
)
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
names(cgc_sub)
supfm <- "Majoidea"
spe <- "Stenorhynchus seticornis"
nms <- names(cgc_sub[[supfm]][[spe]])
nms
tb <- clim_global_tb[[supfm]][[spe]]
tb
tb %>% select(all_of(c("x", "y", nms)))
st_as_sf(
tb %>% select(all_of(c("x", "y", nms))),
coords = c("x", "y"),
crs = "EPSG:4326"
)
names(clim_global$Majoidea)
names(clim_global$Majoidea$`Amphithrax hemphilli`)
clim_global <- sapply(
superFamilies,
\(supfm) {
sapply(
species$species[species$superFamily == supfm],
\(spe) {
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
O <- global_occf[[spe]]
cg <- terra::extract(cgc, O, method = "bilinear", ID = F, xy = T)
return(na.omit(cg))
},
simplify  = F,
USE.NAMES = T
)
},
simplify  = F,
USE.NAMES = T
)
# sélection des variables environnementales uniquement
# et les métriques que l'on veut sélectionner (ici sd et mean)
cgc_sub <- sapply(
names(clim_global),
\(supfm) {
sapply(
names(clim_global[[supfm]]),
\(spe) {
tb <- clim_global[[supfm]][[spe]]
tb <- tb %>%
select(names(.)[grepl("stdv|mean", names(.))])
return(tb)
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
# Filtre des variables colinéaires
cgc_sub <- sapply(
names(cgc_sub),
\(supfm) {
sapply(
names(cgc_sub[[supfm]]),
\(spe) {
tb <- cgc_sub[[supfm]][[spe]]
var_col <- usdm::vifstep(as.data.frame(tb %>% na.omit()))@excluded
tb <- tb[, !names(tb) %in% var_col]
return(tb)
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
# Même object en sf
cgc_sub_sf <- sapply(
names(cgc_sub),
\(supfm) {
sapply(
names(cgc_sub[[supfm]]),
\(spe) {
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
nms <- names(cgc_sub[[supfm]][[spe]])
tb <- clim_global_tb[[supfm]][[spe]]
st_as_sf(
tb %>% select(all_of(c("x", "y", nms))),
coords = c("x", "y"),
crs = "EPSG:4326"
)
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
# Même object en sf
cgc_sub_sf <- sapply(
names(cgc_sub),
\(supfm) {
sapply(
names(cgc_sub[[supfm]]),
\(spe) {
# supfm <- "Majoidea"
# spe <- "Stenorhynchus seticornis"
nms <- names(cgc_sub[[supfm]][[spe]])
tb  <- clim_global[[supfm]][[spe]]
st_as_sf(
tb %>% select(all_of(c("x", "y", nms))),
coords = c("x", "y"),
crs = "EPSG:4326"
)
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
cgc_sub_sf
lapply(cgc_sub_sf, dim)
lapply(cgc_sub_sf$Majoidea, dim)
lapply(cgc_sub_sf$Majoidea, dim) %>% identical(lapply(clim_global$Majoidea, dim))
lapply(cgc_sub_sf$Majoidea, dim) %>% identical(lapply(cgc_sub$Majoidea, dim))
lapply(cgc_sub_sf$Majoidea, nrow) %>% identical(lapply(clim_global$Majoidea, nrow))
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/boot.R")
list(1, 2, 3) + list(4, 5, 6)
list(1, 2, 3)
list(1, 2, 3) %>% append(list(4, 5, 6))
