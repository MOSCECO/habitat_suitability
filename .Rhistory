# m <- mods$wmean
# tb <- vals_hs$wmean
tb_extract_sf <- tibble()
while(length(table(is.nan(tb[, 2]))) > 1) {
print(buffer)
# sélection des valeurs non disponibles
tb_na <- tb %>% filter(is.nan(rf))
# projection
tb_na_sf_pts <- st_as_sf(
tb_na,
coords = c("x", "y"),
remove = F,
crs = "EPSG:4326"
)
tb_na_sfproj <- st_transform(tb_na_sf_pts, crs = utm20n)
# zone tampon
tb_na_sf_plg <- st_buffer(tb_na_sfproj, buffer)
# reprojection
tb_na_sf_plg <- st_transform(tb_na_sf_plg, crs = "EPSG:4326")
# nouvelle extraction
tb_extract <- cbind(
ID = tb_na_sf_plg$ID,
terra::extract(
m, tb_na_sf_plg, fun = \(x) mean(x, na.rm = T), ID = F, xy = T
)
)
# ajout des nouvelles données dans la table initiale
id0_nona <- tb_extract$ID[!is.nan(tb_extract[, 2])]
if(length(id0_nona) > 0) {
id1_nona <- which(!is.nan(tb_extract[, 2]))
nm_na <- names(tb)[apply(tb, 2, \(x) TRUE %in% is.na(x))]
tb[id0_nona, nm_na] <- tb_extract %>% select(-ID) %>% na.omit()
# sauvegarde des polygones utilisées pour extraire les valeurs moyennes
coords <- tb_na_sf_plg[id1_nona, c("x", "y")]
tb_extract <- tb_extract %>%
na.omit() %>%
cbind(coords, buffer = buffer) %>%
st_as_sf()
tb_extract_sf <- tb_extract_sf %>% rbind(tb_extract)
}
# incrémentation de la zone tampon
buffer <- buffer + 25
}
return(
list(hs_val = tb, hs_plg = tb_extract_sf[order(tb_extract_sf$ID), ])
)
},
mods,
hs_extract,
SIMPLIFY = F,
USE.NAMES = T
)
hs <- hs_extract %>% lapply(pluck, "hs_val")
hs <- hs %>% lapply(cbind, obs = spp_local_sf$individualCount)
# Séparation des points selon leurs coordonnées géographiques
hs <- lapply(
hs,
\(tb) {
# tb <- hs$wmean
tb_sf <- st_as_sf(tb, coords = c("x", "y"), remove = F, crs = "EPSG:4326")
tb_sf_isl <- lapply(
islands,
\(nisl) {
# nisl <- "GLP"
bb <- st_bbox(climatologies[[nisl]])
tb_sf %>% st_crop(bb)
}
)
list(ANT = tb_sf) %>% append(tb_sf_isl)
}
)
# densités d'adéquation environnementale ----
densities_hs <- sapply(
names(hs),
\(alg) {
# alg <- names(hs)[[1]]
alg_lab <- switch(
alg, wmean = "Moyenne pondérée", ca = "Moyenne d'ensemble"
)
sapply(
names(hs[[alg]]),
\(nisl) {
# nisl <- names(hs[[alg]])[[1]]
isl_lab <- switch(
nisl,
ANT = "Guadeloupe et Martinique",
GLP = "Guadeloupe",
MTQ = "Martinique"
)
tb <- hs[[alg]][[nisl]]
mapply(
\(alg_mod, alg_col) {
# alg_mod <- "ensemble"
# alg_col <- "red"
tb_long <- tb %>%
pivot_longer(cols = c("rf", "maxent", "ens"))
tb_long <- tb_long %>%
filter(name == alg_mod) %>%
rbind(tb_long %>% filter(name != alg_mod))
tb_long$col <- ifelse(
tb_long$name == alg_mod, alg_col, "darkgrey"
)
tb_long$col <- factor(
tb_long$col, levels = unique(tb_long$col)
)
ggplot(
tb_long,
aes(
x     = value,
group = name,
col   = col,
fill  = col,
alpha = col,
after_stat(count)
)
) +
geom_density() +
scale_color_manual(values = levels(tb_long$col)) +
scale_fill_manual(values = levels(tb_long$col)) +
scale_alpha_manual(values = c(0.6, 0.2)) +
xlab("Adéquation environnementale") +
ylab("Densité * Nombre de points") +
theme(
legend.position = "none",
plot.margin = unit(rep(0.01, 4), "pt")
)
},
c("rf", "maxent", "ens"),
c("red", "green", "blue"),
SIMPLIFY = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
},
simplify = F,
USE.NAMES = T
)
alg <- names(hs)[[1]]
hs$wmean$ANT
hs$wmean$GLP %>% dim()
alg <- names(hs)[[1]]
alg_lab <- switch(
alg, wmean = "Moyenne pondérée", ca = "Moyenne d'ensemble"
)
nisl <- names(hs[[alg]])[[1]]
isl_lab <- switch(
nisl,
ANT = "Guadeloupe et Martinique",
GLP = "Guadeloupe",
MTQ = "Martinique"
)
isl_lab
nisl <- names(hs[[alg]])[[2]]
nisl
isl_lab <- switch(
nisl,
ANT = "Guadeloupe et Martinique",
GLP = "Guadeloupe",
MTQ = "Martinique"
)
tb <- hs[[alg]][[nisl]]
tb
dim(tb)
alg_mod <- "ensemble"
alg_col <- "red"
names(tb)
tb_long <- tb %>%
pivot_longer(cols = c("rf", "maxent", "ens"))
names(tb_long)
head(tb_long)
dim(tb_long)
View(tb_long)
alg_mod
tb_long <- tb_long %>%
filter(name == alg_mod) %>%
rbind(tb_long %>% filter(name != alg_mod))
tb_long$col <- ifelse(
tb_long$name == alg_mod, alg_col, "darkgrey"
)
tb_long$col <- factor(
tb_long$col, levels = unique(tb_long$col)
)
ggplot(
tb_long,
aes(
x     = value,
group = name,
col   = col,
fill  = col,
alpha = col,
after_stat(count)
)
) +
geom_density()
ggplot(
tb_long,
aes(
x     = value,
group = name,
col   = col,
fill  = col,
alpha = col,
after_stat(count)
)
) +
geom_density() +
scale_color_manual(values = levels(tb_long$col)) +
scale_fill_manual(values = levels(tb_long$col)) +
scale_alpha_manual(values = c(0.6, 0.2)) +
xlab("Adéquation environnementale") +
ylab("Densité * Nombre de points") +
theme(
legend.position = "none",
plot.margin = unit(rep(0.01, 4), "pt")
)
dim(tb)
View(tb)
ggplot(
tb_long,
aes(
x     = value,
group = name,
col   = col,
fill  = col,
alpha = col
)
) +
geom_density()
ggplot(
tb_long,
aes(
x     = value,
group = name,
col   = col,
fill  = col,
alpha = col,
after_stat(count)
)
) +
geom_density()
tb_long
names(tb_long)
tb_long %>% filter(name == "rf")
ggplot(
tb_long %>% filter(name == "rf"),
aes(
x     = value,
after_stat(count)
)
) +
geom_density()
d <- tb_long %>% filter(name == "rf")
summary(d$value)
d <- tb_long %>% filter(name == "maxent")
summary(d$value)
ggplot(
d,
aes(
x     = value,
after_stat(count)
)
) +
geom_density()
# Importation des occurrences d'espèces Guadeloupe/Martinique ----
spp_local_sf <- st_as_sf(
pa[[bn]] %>% as.data.frame(xy = T),
coords = c("x", "y"),
remove = F,
crs = "EPSG:4326"
)
names(spp_local_sf)
# Importation des occurrences d'espèces Guadeloupe/Martinique ----
spp_local_sf <- st_as_sf(
pa[[bn]] %>% as.data.frame(xy = T),
coords = c("x", "y"),
remove = F,
crs = "EPSG:4326"
) %>% filter(individualCount > 0)
spp_local_sf
dim(spp_local_sf)
pa[[bn]] %>% as.data.frame(xy = T)
a <- pa[[bn]] %>% as.data.frame(xy = T)
table(a$individualCount)
# Importation des occurrences d'espèces Guadeloupe/Martinique ----
spp_local_sf <- st_as_sf(
pa[[bn]] %>% as.data.frame(xy = T),
coords = c("x", "y"),
remove = F,
crs = "EPSG:4326"
) %>% filter(individualCount > 0)
# Importation des occurrences d'espèces Guadeloupe/Martinique ----
spp_local_sf <- st_as_sf(
pa[[bn]] %>% as.data.frame(xy = T),
coords = c("x", "y"),
remove = F,
crs = "EPSG:4326"
) %>% filter(individualCount > 0)
# Densité des adéquations de l'habitat associées aux occurrences ----
hs_extract <- lapply(
mods, terra::extract, spp_local_sf, method = "bilinear", xy = T
)
# Complétion des NaN
buffer = 150
hs_extract <- mapply(
\(m, tb) {
# m <- mods$wmean
# tb <- vals_hs$wmean
tb_extract_sf <- tibble()
while(length(table(is.nan(tb[, 2]))) > 1) {
print(buffer)
# sélection des valeurs non disponibles
tb_na <- tb %>% filter(is.nan(rf))
# projection
tb_na_sf_pts <- st_as_sf(
tb_na,
coords = c("x", "y"),
remove = F,
crs = "EPSG:4326"
)
tb_na_sfproj <- st_transform(tb_na_sf_pts, crs = utm20n)
# zone tampon
tb_na_sf_plg <- st_buffer(tb_na_sfproj, buffer)
# reprojection
tb_na_sf_plg <- st_transform(tb_na_sf_plg, crs = "EPSG:4326")
# nouvelle extraction
tb_extract <- cbind(
ID = tb_na_sf_plg$ID,
terra::extract(
m, tb_na_sf_plg, fun = \(x) mean(x, na.rm = T), ID = F, xy = T
)
)
# ajout des nouvelles données dans la table initiale
id0_nona <- tb_extract$ID[!is.nan(tb_extract[, 2])]
if(length(id0_nona) > 0) {
id1_nona <- which(!is.nan(tb_extract[, 2]))
nm_na <- names(tb)[apply(tb, 2, \(x) TRUE %in% is.na(x))]
tb[id0_nona, nm_na] <- tb_extract %>% select(-ID) %>% na.omit()
# sauvegarde des polygones utilisées pour extraire les valeurs moyennes
coords <- tb_na_sf_plg[id1_nona, c("x", "y")]
tb_extract <- tb_extract %>%
na.omit() %>%
cbind(coords, buffer = buffer) %>%
st_as_sf()
tb_extract_sf <- tb_extract_sf %>% rbind(tb_extract)
}
# incrémentation de la zone tampon
buffer <- buffer + 25
}
return(
list(hs_val = tb, hs_plg = tb_extract_sf[order(tb_extract_sf$ID), ])
)
},
mods,
hs_extract,
SIMPLIFY = F,
USE.NAMES = T
)
hs <- hs_extract %>% lapply(pluck, "hs_val")
hs <- hs %>% lapply(cbind, obs = spp_local_sf$individualCount)
# Séparation des points selon leurs coordonnées géographiques
hs <- lapply(
hs,
\(tb) {
# tb <- hs$wmean
tb_sf <- st_as_sf(tb, coords = c("x", "y"), remove = F, crs = "EPSG:4326")
tb_sf_isl <- lapply(
islands,
\(nisl) {
# nisl <- "GLP"
bb <- st_bbox(climatologies[[nisl]])
tb_sf %>% st_crop(bb)
}
)
list(ANT = tb_sf) %>% append(tb_sf_isl)
}
)
tb <- hs[[alg]][[nisl]]
dim(tb)
tb_long <- tb %>%
pivot_longer(cols = c("rf", "maxent", "ens"))
tb_long <- tb_long %>%
filter(name == alg_mod) %>%
rbind(tb_long %>% filter(name != alg_mod))
tb_long$col <- ifelse(
tb_long$name == alg_mod, alg_col, "darkgrey"
)
tb_long$col <- factor(
tb_long$col, levels = unique(tb_long$col)
)
ggplot(
tb_long,
aes(
x     = value,
group = name,
col   = col,
fill  = col,
alpha = col,
after_stat(count)
)
) +
geom_density() +
scale_color_manual(values = levels(tb_long$col)) +
scale_fill_manual(values = levels(tb_long$col)) +
scale_alpha_manual(values = c(0.6, 0.2)) +
xlab("Adéquation environnementale") +
ylab("Densité * Nombre de points") +
theme(
legend.position = "none",
plot.margin = unit(rep(0.01, 4), "pt")
)
?density
?geom_dentisty
?geom_density
ggplot(
tb_long,
aes(
x     = value,
group = name,
col   = col,
fill  = col,
alpha = col,
after_stat(count)
)
) +
geom_density() +
scale_color_manual(values = levels(tb_long$col)) +
scale_fill_manual(values = levels(tb_long$col)) +
scale_alpha_manual(values = c(0.6, 0.2)) +
xlab("Adéquation environnementale") +
ylab("Fréquence (présences uniquement)") +
theme(
legend.position = "none",
plot.margin = unit(rep(0.01, 4), "pt")
)
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_hs.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/boot.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/boot.R")
here("figures", "compilation", "Muricoidea", "Claremontiella nodulosa", "compilation_hs_muri_Cla.nod_ca_ant_pocc.png)
![](`r here("figures", "compilation", "Muricoidea", "Claremontiella nodulosa", "compilation_hs_muri_Cla.nod_ca_ant_pocc.png)`)
`r cat(here("figures", "compilation", "Muricoidea", "Claremontiella nodulosa", "compilation_hs_muri_Cla.nod_ca_ant_pocc.png))`
cat(here("figures", "compilation", "Muricoidea", "Claremontiella nodulosa", "compilation_hs_muri_Cla.nod_ca_ant_pocc.png))
)
)
)
)
)
![](`r cat(here("figures", "compilation", "Muricoidea", "Claremontiella nodulosa", "compilation_hs_muri_Cla.nod_ca_ant_pocc.png"))`)
cat(here("figures", "compilation", "Muricoidea", "Claremontiella nodulosa", "compilation_hs_muri_Cla.nod_ca_ant_pocc.png"))
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
pout
dev.off()
length(pout)
length(pout[[]])
length(pout[[1]])
length(pout[[1]][[1]])
length(pout[[1]][[1]][[1]])
length(pout[[1]][[1]][[1]][[1]])
length(pout[[1]][[1]][[1]][[1]][[1]])
length(pout[[1]][[1]][[1]][[1]][[1]][[1]])
length(pout[[1]][[1]][[1]][[1]][[1]][[1]][[1]])
length(pout[[1]][[1]][[1]][[1]][[1]][[1]][[1]][[1]])
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
traceback()
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
pout$`Mithraculus forceps`$wmean$ANT
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
o1 <- pout$`Mithraculus forceps`$wmean$MTQ$pocc$phig
o2 <- pout$`Mithraculus forceps`$wmean$MTQ$aocc$phig
o3 <- pout$`Mithraculus forceps`$wmean$MTQ$aocc$plow
x11(); o1/o2/o3
x11(); (o1/o2/o3) + plot_layout(heights = c(0.4, 0.4, 0.2))
x11(); (o1/o2/o3) + plot_layout(heights = c(0.45, 0.45, 0.1))
x11(); (o1/o2/o3) + plot_layout(
heights = c(0.45, 0.45, 0.1),
widths = c(1, 1, 0.8)
)
x11(); (o1/o2/o3) + plot_layout(
heights = c(0.45, 0.45, 0.1),
widths = c(5, 5, 0.8)
)
x11(); (o1/o2/o3) + plot_layout(
# heights = c(0.45, 0.45, 0.1),
widths = c(5, 5, 0.8)
)
?plot_layout
x11(); (o1/o2/o3) + plot_layout(
heights = c(0.45, 0.45, 0.1),
widths = c(100, 100, 10)
)
x11(); (o1/o2/o3) + plot_layout(
heights = c(0.45, 0.45, 0.1),
widths = c(1, 1, 0.5)
)
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/FUN/FUN_joinedMaps.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/FUN/FUN_joinedMaps.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
source("~/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/scripts/SDM05_verification_pa.R")
?BIOMOD_EnsembleModeling
a <- "/home/borea/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/data/analysis/depth_boundaries/Stenorhynchus_seticornis_depth_boundaries.rds"
b <- readRDS(a)
b
a <- "/home/borea/Documents/mosceco/r_projects/MOSCECO_L2/habitat_suitability/data/analysis/depth_boundaries/Claremontiella_nodulosa_depth_boundaries.rds"
b <- readRDS(a)
b
